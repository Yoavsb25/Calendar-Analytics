{% extends "base.html" %}

{% block title %}Event Report | {{ month }}/{{ year }}{% endblock %}
{% block header_title %}Event Insights: {{ ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'][month-1] }} {{ year }}{% endblock %}

{% block content %}
    <div class="report-container">
        {% if events %}
            <div class="stats-overview">
                <div class="stat-card total-events">
                    <div class="stat-icon">
                        <i data-feather="calendar"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ events|length }}</h3>
                        <p>Total Unique Events</p>
                    </div>
                </div>
                <div class="stat-card total-revenue">
                    <div class="stat-icon">
                        <i data-feather="dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3>${{ events|map(attribute='total')|sum|round(2) }}</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>
            </div>

            <form method="POST" action="{{ url_for('save_report') }}" id="event-report-form">
                <div class="events-table-container">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Event Name</th>
                                <th>Number of Meetings</th>
                                <th>Price per Meeting</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in events|sort(attribute='count', reverse=true) %}
                            <tr>
                                <td>{{ event.name }}</td>
                                <td>{{ event.count }}</td>
                                <td>
                                    <input type="number"
                                           name="price_{{ loop.index0 }}"
                                           value="{{ event.price|round(2) }}"
                                           step="0.01"
                                           min="0"
                                           class="price-input"
                                           onchange="updateTotal(this)"
                                           data-index="{{ loop.index0 }}"
                                    >
                                </td>
                                <td class="total-cell">${{ (event.count * event.price)|round(2) }}</td>
                                <!-- Add hidden input for the event name -->
                                <input type="hidden" name="event_name_{{ loop.index0 }}" value="{{ event.name }}">
                                <input type="hidden" name="count_{{ loop.index0 }}" value="{{ event.count }}">
                            </tr>

                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">Total Revenue</td>
                                <td id="grand-total">${{ events|map(attribute='total')|sum|round(2) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <input type="hidden" name="month" value="{{ month }}">
                <input type="hidden" name="year" value="{{ year }}">
                <button type="submit" class="btn btn-primary mt-3">Save Report</button>
            </form>
        {% else %}
            <div class="no-events">
                <i data-feather="calendar-off" class="no-events-icon"></i>
                <h2>No Events Found</h2>
                <p>There are no events scheduled for this month.</p>
            </div>
        {% endif %}
    </div>

    <script>
    // Prevent form submission on Enter
    document.getElementById('event-report-form').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
        }
    });

    // Function to dynamically update totals
    function updateTotal(priceInput) {
        const row = priceInput.closest('tr');

        // Get the number of meetings from the second column and parse it as a number
        const meetingCount = parseFloat(row.querySelector('td:nth-child(2)').textContent) || 0;

        // Get the price from the input and parse it
        const price = parseFloat(priceInput.value) || 0;

        // Calculate the row total
        const total = (meetingCount * price).toFixed(2);

        // Update the row's total cell
        const totalCell = row.querySelector('.total-cell');
        totalCell.textContent = `$${total}`;

        // Recalculate the grand total from all rows
        const totalCells = document.querySelectorAll('.total-cell');
        const grandTotal = Array.from(totalCells).reduce((sum, cell) => {
            return sum + parseFloat(cell.textContent.replace('$', '')) || 0;
        }, 0);

        // Update the grand total in the table footer
        document.getElementById('grand-total').textContent = `$${grandTotal.toFixed(2)}`;

        // Update the box total revenue
        const totalRevenueBox = document.querySelector('.stat-card.total-revenue h3');
        if (totalRevenueBox) {
            totalRevenueBox.textContent = `$${grandTotal.toFixed(2)}`;
        }
    }
</script>

{% endblock %}